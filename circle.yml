machine:
  environment:
    R_LIBS_USER: ~/R
    PATH: "$PATH:$HOME/bin"

dependencies:
  cache_directories:
    - ~/R
    - ~/bin
    - blogdown
  pre:
    - "[ ! -d ~/R ] && mkdir ~/R || true"
    - "[ ! -d ~/bin ] && mkdir ~/bin || true"
    - echo 'options(repos = "https://cran.rstudio.com", blogdown.method = "custom")' > ~/.Rprofile
  post:
    - sudo apt-add-repository -y "deb https://cran.rstudio.com/bin/linux/ubuntu `lsb_release -cs`/"
    - sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E084DAB9
    - sudo apt-get update
    - sudo apt-get -y install r-base-dev
    - R -e '.libPaths(); sessionInfo()'
    - Rscript -e 'if (!requireNamespace("devtools")) install.packages("devtools"); devtools::install_github("rstudio/blogdown")'
    - Rscript -e "blogdown::install_hugo(); blogdown::hugo_build()"

test:
  post:
    - ls public

deployment:
  production:
    branch: master
    commands:
      - Rscript -e "blogdown::hugo_build(local = FALSE)"
      - aws s3 sync public/ s3://rviews.rstudio.com/ --acl public-read
  staging:
    branch: /.*/
    commands:
      - Rscript -e "blogdown::hugo_build(local = TRUE)"
      - aws s3 sync public/ s3://beta.rviews.rstudio.com/ --acl public-read
