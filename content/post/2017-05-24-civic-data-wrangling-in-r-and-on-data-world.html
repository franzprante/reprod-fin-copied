---
title: 'Civic Data Wrangling: in R and on data.world'
author: "Jennifer Thompson (in collaboration with Rafael Pereira)"
date: '2017-05-26'
categories: 
  - R Language
  - Data Science
  - Applications
tags: 
 - R
 - Data Wrangling
 - data.world
---


<p>One of the most valuable things I have learned working on Data for Democracy’s Medicare drug spending project has been the value of collaborative tools. It has been my first in-depth experience using Github collaboratively, for one, but it has also introduced me to <a href="https://data.world">data.world</a>.</p>
<p>data.world is an intuitive way to store, organize, explore, and visualize individual data files, making them more visible to and usable for anyone who’s interested. Using the <a href="https://github.com/datadotworld/data.world-r">data.world R package</a>, I was able to collect the data I needed for one dashboard, create and publish a derived dataset, and build a Shiny dashboard that pulls live data from the site — all with complete visibility to my D4D teammates, who can now directly and easily access both the original and derived datasets.</p>
<div id="the-beginning" class="section level2">
<h2>The Beginning</h2>
<p>Back in December, I started seeing posts about <a href="http://datafordemocracy.org/">Data for Democracy</a> floating around, and the idea immediately piqued my interest. I joined up not knowing what I would be doing exactly.</p>
<p>One of the ideas among pilot projects suggested by D4D leader Jonathon Morgan was looking at Medicare spending. Specifically, starting with the <a href="https://www.cms.gov/Research-Statistics-Data-and-Systems/Statistics-Trends-and-Reports/Information-on-Prescription-Drugs/2015MedicareData.html">prescription spending data for 2011-2015</a> released by the Centers for Medicare and Medicaid Services. Out of all the original project ideas (check out the <a href="http://datafordemocracy.org/projects.html">current and growing list of projects</a> and be amazed), this one was most in my wheelhouse, and I jumped into the discussions to see what might happen.</p>
<p>D4D started developing some leadership structure, and Matt Gawarecki and I were asked to lead the drug spending project. We began by tidying the <a href="https://medicare.com/medicare-part-d/part-d-prescription-drug-coverage/">Medicare Part D</a> spending data available from CMS.gov, which was straightforward enough (thanks, CMS!), and initially stored all that on our Github repo.</p>
<p>Soon, our A+ team of volunteers found data on therapeutic classes, lobbying expenditures, manufacturers, and more. As we looked for a better place to store and collaborate on our datasets, D4D projects started to leverage data.world. We decided that data.world was a good place for <a href="https://data.world/data4democracy/drug-spending">our data, too</a>.</p>
<p>At that point, one of the first things we wanted to do was look at spending and prescribing patterns for specific medications, which would help us see what we were dealing with and generate some ideas for future analysis. James Porter drafted a Shiny app for visualizing users, claims, and costs for the most commonly prescribed medications over the five years of data available. <a href="https://jenniferthompson.shinyapps.io/shinydashboard-medicared/">I built on top of James’ work</a>, and the full source code is available on <a href="https://github.com/Data4Democracy/drug-spending/tree/master/R/apps/shinydashboard-medicared">Github</a>.</p>
</div>
<div id="the-data" class="section level2">
<h2>The Data</h2>
<div id="setup-and-initial-analysis" class="section level3">
<h3>Setup and Initial Analysis</h3>
<p>Once we got the CMS spending data pulled out of its original Excel format, tidied, and uploaded, I used the <a href="https://github.com/datadotworld/data.world-r">data.world package</a> to <a href="https://docs.data.world/tutorials/dwsql/#metadata-tables">query the schema metadata</a> and see exactly how tables were named, choose the right files, and pull them directly into R.</p>
<p><em>(To run this, you’ll need your data.world API token, which I saved as <code>DW_API</code> in an <code>.Renviron</code> file to make my code shareable.)</em></p>
<pre class="r"><code>library(tidyverse)
library(data.world)</code></pre>
<pre class="r"><code># API token is saved in .Renviron

data.world::set_config(cfg_env(&quot;DW_API&quot;))

# Datasets are identified by their URL
drugs_ds &lt;- &quot;https://data.world/data4democracy/drug-spending&quot;

# List tables
data_list &lt;- data.world::query(
  qry_sql(&quot;SELECT * FROM Tables&quot;),
  dataset = drugs_ds)

# data_list is a tbl_df with two columns: tableID and tableName.
data_list$tableName</code></pre>
<pre><code>##  [1] &quot;FDA_NDC_Product&quot;             &quot;Data&quot;                       
##  [3] &quot;Methods&quot;                     &quot;Variables&quot;                  
##  [5] &quot;Pharma_Lobby&quot;                &quot;atc-codes&quot;                  
##  [7] &quot;companies_drugs_keyed&quot;       &quot;drug_list&quot;                  
##  [9] &quot;drug_uses&quot;                   &quot;drugdata_clean&quot;             
## [11] &quot;drugnames_withclasses&quot;       &quot;lobbying_keyed&quot;             
## [13] &quot;manufacturers_drugs_cleaned&quot; &quot;meps_full_2014&quot;             
## [15] &quot;spending-2011&quot;               &quot;spending-2012&quot;              
## [17] &quot;spending-2013&quot;               &quot;spending-2014&quot;              
## [19] &quot;spending-2015&quot;               &quot;spending_all_top100&quot;        
## [21] &quot;usp_drug_classification&quot;</code></pre>
</div>
<div id="yearly-data-consolidation" class="section level3">
<h3>Yearly Data Consolidation</h3>
<p>The CMS data is stored in the five <code>spending-201x</code> tables, one per year. I read those directly from data.world by writing a simple SQL query identifying those table names, then used <code>dplyr</code> and <code>purrr</code> to quickly add a year variable to each and combine them:</p>
<pre class="r"><code># Function to read in a single year&#39;s CSV from data.world and add year
get_year &lt;- function(yr) {
  data.world::query(qry_sql(paste0(&quot;SELECT * FROM `spending-&quot;, yr, &quot;`&quot;)),
    dataset = drugs_ds)[,-1] %&gt;%
    ## First column is a row number; don&quot;t need that
    mutate(year = yr)
}

# Read in and combine all years&#39; data
spend &lt;- map_df(2011:2015, get_year)</code></pre>
</div>
<div id="most-popular-generic-drugs" class="section level3">
<h3>Most Popular Generic Drugs</h3>
<p>To keep runtime and drop-down menus reasonable, we currently only include the 100 drugs with the most users over the five-year period.</p>
<p>The app allows users to select any one of those to look at people-related values (e.g., the number of users or the number of claims) and spending-related values (e.g., total costs, average out-of-pocket costs for users receiving and not receiving low-income subsidies).</p>
<p>The <a href="https://data.world/data4democracy/drug-spending/file/spending-2011.csv">datasets</a> include one record per drug brand name.</p>
<p><img src="/post/2017-05-24-civic-data-wrangling-in-r-and-on-data-world_files/dw_file_preview.png" alt="Sample file on data.world" /> Each generic drug may appear with several brand names. Metformin HCL, for example, has over 35 brand names - Glucophage XR, Glumetza, etc. To include them in my analysis, I calculated the total number of users and units per year for each generic, added those values to the original dataset, then selected the 100 most common generics during that five-year period.</p>
<pre class="r"><code># Add a row for each generic with overall summaries of each variable ----------
spend_overall &lt;- spend %&gt;%
  group_by(drugname_generic, year) %&gt;%
  summarise(
    claim_count = sum(claim_count, na.rm = TRUE),
    total_spending = sum(total_spending, na.rm = TRUE),
    user_count = sum(user_count, na.rm = TRUE),
    unit_count = sum(unit_count, na.rm = TRUE),
    user_count_non_lowincome = sum(user_count_non_lowincome, na.rm = TRUE),
    user_count_lowincome = sum(user_count_lowincome, na.rm = TRUE)
  ) %&gt;%
  mutate(
    total_spending_per_user = total_spending / user_count,
    drugname_brand = &quot;ALL BRAND NAMES&quot;,
    ## Add NA values for variables that are brand-specific
    unit_cost_wavg = NA,
    out_of_pocket_avg_lowincome = NA,
    out_of_pocket_avg_non_lowincome = NA
  ) %&gt;%
  ungroup()

# Select top 100 generics by number of users across all five years ------------
by_user_top100 &lt;- group_by(spend_overall, drugname_generic) %&gt;%
  summarise(total_users = sum(user_count, na.rm = TRUE)) %&gt;%
  arrange(desc(total_users)) %&gt;%
  slice(1:100)

# For top 100 generics, add ALL BRAND NAMES rows to by-brand-name rows --------
spend_all_top100 &lt;- bind_rows(spend, spend_overall) %&gt;%
  filter(drugname_generic %in% by_user_top100$drugname_generic) %&gt;%
  arrange(drugname_generic)</code></pre>
</div>
<div id="saving-the-work" class="section level3">
<h3>Saving The Work</h3>
<p>Once I had the final dataset with just our top 100, I uploaded it directly to data.world as a CSV via the <code>dwapi</code> package, which is bundled, and loaded automatically, with <code>data.world</code>:</p>
<pre class="r"><code># Write final file to data.world using package ------------------------------------

# data.world&#39;s REST API methods are available via the dwapi package
dwapi::upload_data_frame(
  dataset = drugs_ds,
  file_name = &quot;spending_all_top100.csv&quot;,
  data_frame = spend_all_top100
)</code></pre>
</div>
</div>
<div id="the-app" class="section level2">
<h2>The App</h2>
<p>Now that the initial data management is done, the app’s <code>global.R</code> reads the “top 100” CSV directly from data.world, and we’re all set.</p>
<pre class="r"><code># Read in datasets used for all plots ----------------------------------------
library(data.world)

# API token is saved in .Renviron (DW_API)
data.world::set_config(cfg_env(&quot;DW_API&quot;))

# Read in dataset from data.world
drug_costs_everything &lt;-
  data.world::query(
    qry_sql(&quot;SELECT * FROM `spending_all_top100`&quot;),
    dataset = &quot;data4democracy/drug-spending&quot;)</code></pre>
<p>The app is available to the public and can be accessed at <a href="https://jenniferthompson.shinyapps.io/shinydashboard-medicared/" class="uri">https://jenniferthompson.shinyapps.io/shinydashboard-medicared/</a>.</p>
<iframe src="https://jenniferthompson.shinyapps.io/shinydashboard-medicared/" height="450" width="100%">
</iframe>
</div>
<div id="whats-next" class="section level2">
<h2>What’s next?</h2>
<p>The current app only uses a few of the datasets that are available on data.world, but we hope to be able to classify drugs by therapeutic class (e.g., all diabetes medications) soon. Once we have that information stored on data.world, we will be able to read data from both tables, join them, and give users the option to visualize some information by therapeutic class as well as by individual medication.</p>
<p>This is harder than one might think, and we <a href="https://data.world/data4democracy/drug-spending/discuss/drug-spending/7047">welcome expertise</a> from those who might try!</p>
<p>Finally, if you have tried data.world and have used it for your projects, make sure to share your stories, suggestions and complaints with <a href="https://github.com/datadotworld/data.world-r/issues">the team</a>.</p>
<hr />
<div id="about-the-author" class="section level4">
<h4>About the author</h4>
<p>Jennifer Thompson is a well-rounded conversationalist and a standup woman who spends her days as a biostatistician and avid R user. Jennifer is <a href="https://data.world/jthompson">@jthompson</a> on data.world and <a href="https://twitter.com/jent103">@jent103</a> on Twitter.</p>
</div>
</div>
